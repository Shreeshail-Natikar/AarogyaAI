<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">AarogyaAI - ‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ‡≥Ä‡≤£ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and basic styling for modern look */
        body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
        /* Adjusted height calculation for reliable chat scrolling */
        .chat-container { height: calc(100vh - 12rem); overflow-y: auto; }
        .message { max-width: 85%; padding: 0.75rem 1rem; border-radius: 1rem; margin-bottom: 0.5rem; }
        .user-message { background-color: #3b82f6; color: white; margin-left: auto; border-bottom-right-radius: 0; }
        .ai-message { background-color: #e5e7eb; color: #1f2937; border-bottom-left-radius: 0; }
        /* Style for the fixed input area */
        .chat-input-fixed {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            max-width: 480px; /* Matching the max-w-md container width */
            margin: 0 auto;
            z-index: 20;
            background-color: white;
            border-top: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="min-h-screen">

    <div id="app" class="max-w-md mx-auto bg-white shadow-xl min-h-screen relative">
        
        <header class="p-4 bg-emerald-600 text-white shadow-lg sticky top-0 z-10 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">üè• AarogyaAI</h1>
                <p id="header-tagline" class="text-sm font-light">AI ‡≤ö‡≤æ‡≤≤‡≤ø‡≤§ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø, ‡≤π‡≤≥‡≥ç‡≤≥‡≤ø‡≤ó‡≤≥‡≤ø‡≤ó‡≤æ‡≤ó‡≤ø</p>
            </div>
            
            <div class="flex items-center space-x-2"> <button id="voice-toggle-btn" onclick="toggleVoiceOutput()" class="p-2 rounded-full transition duration-150 text-white" title="Toggle Voice Output">
                    <svg id="voice-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                </button>

                <select id="language-selector" onchange="changeLanguage(this.value)" class="bg-emerald-700 text-white border border-emerald-500 rounded-lg p-2 text-sm focus:ring-white focus:border-white">
                    <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° (Kannada)</option>
                    <option value="en">English</option>
                    <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                </select>
            </div>
        </header>

        <div class="flex border-b border-gray-200 sticky top-[4rem] bg-white z-10">
            <button onclick="showSection('chat')" id="tab-chat" class="flex-1 py-3 text-center border-b-2 font-semibold transition duration-200 text-emerald-700 border-emerald-700">ü§ñ AI ‡≤∏‡≤≤‡≤π‡≥Ü</button>
            <button onclick="showSection('map')" id="tab-map" class="flex-1 py-3 text-center text-gray-500 hover:text-emerald-700 hover:border-emerald-700">üìç ‡≤∏‡≤Ç‡≤™‡≤®‡≥ç‡≤Æ‡≥Ç‡≤≤</button>
            <button onclick="showSection('reminder')" id="tab-reminder" class="flex-1 py-3 text-center text-gray-500 hover:text-emerald-700 hover:border-emerald-700">‚è∞ ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü</button>
        </div>

        <section id="section-chat" class="p-4 relative min-h-[calc(100vh-12rem)]">
            <div id="disclaimer-box" class="p-3 mb-4 bg-yellow-100 text-yellow-800 border border-yellow-300 rounded-lg text-sm font-medium">
                ‚ö†Ô∏è **‡≤π‡≤ï‡≥ç‡≤ï‡≥Å‡≤§‡≥ç‡≤Ø‡≤æ‡≤ó (Disclaimer):** ‡≤á‡≤¶‡≥Å AI ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞. ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤ï‡≥Ä‡≤Ø ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø‡≤ï‡≥ç‡≤ï‡≤æ‡≤ó‡≤ø ‡≤á‡≤¶‡≤®‡≥ç‡≤®‡≥Å ‡≤¨‡≤≥‡≤∏‡≤¨‡≥á‡≤°‡≤ø. ‡≤§‡≤ï‡≥ç‡≤∑‡≤£ ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≠‡≥á‡≤ü‡≤ø ‡≤Æ‡≤æ‡≤°‡≤ø.
            </div>

            <div id="chat-messages" class="chat-container space-y-3 p-2 bg-gray-50 rounded-lg border pb-4">
                <div class="ai-message" id="welcome-message">‡≤®‡≤æ‡≤®‡≥Å AarogyaAI. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∞‡≥ã‡≤ó‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥ ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤∏‡≤Ç‡≤ï‡≥ç‡≤∑‡≤ø‡≤™‡≥ç‡≤§‡≤µ‡≤æ‡≤ó‡≤ø ‡≤ï‡≤®‡≥ç‡≤®‡≤°‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤§‡≤ø‡≤≥‡≤ø‡≤∏‡≤ø.</div>
            </div>

            <div class="flex p-4 chat-input-fixed max-w-md space-x-2">
                <button id="mic-btn" onclick="startVoiceInput()" class="bg-gray-300 text-gray-700 p-3 rounded-full hover:bg-gray-400 transition duration-150 flex-shrink-0 w-12 h-12 flex items-center justify-center" title="Voice Input">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" clip-rule="evenodd" />
                        <path d="M14.73 10.73a7 7 0 01-1.73 4.27v1.5H7v-1.5a7 7 0 01-1.73-4.27H4a8 8 0 005.5 7.5V19h1.5v-1.5a8 8 0 005.5-7.5h-1.27z" />
                    </svg>
                </button>
                <input type="text" id="chat-input" placeholder="‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∞‡≥ã‡≤ó‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø..." class="flex-1 p-3 border border-gray-300 rounded-full focus:ring-emerald-500 focus:border-emerald-500">
                <button id="send-btn" onclick="sendQuery()" class="bg-emerald-600 text-white p-3 rounded-full font-semibold hover:bg-emerald-700 transition duration-150 flex-shrink-0">‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≥Å</button>
            </div>
        </section>

        <section id="section-map" class="p-4 hidden">
            <h2 id="map-title" class="text-lg font-semibold mb-3 text-emerald-800">üìç ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤ï‡≥á‡≤Ç‡≤¶‡≥ç‡≤∞ ‡≤∂‡≥ã‡≤ß‡≤ï</h2>
            <p id="map-desc" class="mb-4 text-gray-600">‡≤à ‡≤µ‡≥à‡≤∂‡≤ø‡≤∑‡≥ç‡≤ü‡≥ç‡≤Ø‡≤µ‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≥ç‡≤•‡≤≥‡≤¶ ‡≤Ü‡≤ß‡≤æ‡≤∞‡≤¶ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ü‡≤∏‡≥ç‡≤™‡≤§‡≥ç‡≤∞‡≥Ü‡≤ó‡≤≥‡≥Å, ‡≤ï‡≥ç‡≤≤‡≤ø‡≤®‡≤ø‡≤ï‡≥ç‚Äå‡≤ó‡≤≥‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤î‡≤∑‡≤ß‡≤æ‡≤≤‡≤Ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤π‡≤ø‡≤°‡≤ø‡≤Ø‡≤≤‡≥Å Google Maps ‡≤Ö‡≤®‡≥ç‡≤®‡≥Å ‡≤¨‡≤≥‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü.</p>
            
            <button id="find-hospitals-btn" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-blue-700 transition duration-150">
                GPS ‡≤∏‡≥ç‡≤•‡≤≥‡≤¶ ‡≤Ü‡≤ß‡≤æ‡≤∞‡≤¶ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø
            </button>

            <div id="map-results" class="mt-4 p-4 bg-gray-100 rounded-lg text-sm hidden">
                <p class="font-semibold text-gray-700">‡≤´‡≤≤‡≤ø‡≤§‡≤æ‡≤Ç‡≤∂: Google Maps ‡≤§‡≥Ü‡≤∞‡≥Ü‡≤Ø‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...</p>
                <p class="text-xs text-gray-500 mt-1">‡≤∏‡≥ç‡≤•‡≤≥ ‡≤∏‡≥á‡≤µ‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤≤‡≤≠‡≥ç‡≤Ø‡≤µ‡≤æ‡≤¶ ‡≤§‡≤ï‡≥ç‡≤∑‡≤£, Google Maps ‡≤Ö‡≤™‡≥ç‡≤≤‡≤ø‡≤ï‡≥á‡≤∂‡≤®‡≥ç ‡≤§‡≥Ü‡≤∞‡≥Ü‡≤Ø‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤®‡≤ø‡≤Æ‡≤ó‡≥Ü ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤Ç‡≤™‡≤®‡≥ç‡≤Æ‡≥Ç‡≤≤‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤§‡≥ã‡≤∞‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü.</p>
                <div id="map-iframe-placeholder" class="mt-4 w-full h-48 bg-gray-300 rounded-lg flex items-center justify-center text-gray-600">
                    Map Placeholder
                </div>
            </div>
        </section>

        <section id="section-reminder" class="p-4 hidden">
            <h2 id="reminder-title" class="text-lg font-semibold mb-3 text-emerald-800">‚è∞ ‡≤î‡≤∑‡≤ß ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü</h2>
            <p id="reminder-desc" class="mb-4 text-gray-600">‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø. ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≥ç‡≤™‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≤µ‡≥Ü„ÄÇ</p>
            
            <div id="auth-status" class="mb-4 p-2 bg-gray-100 rounded-lg text-sm text-gray-600 border border-gray-300">Connecting to database...</div>
            
            <label id="med-name-label" for="med-name" class="block text-sm font-medium text-gray-700">‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å</label>
            <input type="text" id="med-name" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">

            <label id="med-time-label" for="med-time" class="block text-sm font-medium text-gray-700 mt-4">‡≤∏‡≤Æ‡≤Ø (Time)</label>
            <input type="time" id="med-time" class="mt-1 block w-full p-3 border border-gray-300 rounded-lg">

            <button onclick="setReminder()" id="set-reminder-btn" class="w-full mt-6 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-md hover:bg-purple-700 transition duration-150">
                ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü ‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤ø
            </button>

            <div id="reminder-list" class="mt-6 space-y-2">
                <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-800" id="loading-reminders">Loading reminders...</div>
            </div>
        </section>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ************************************************
        // CRITICAL: PASTE YOUR GEMINI API KEY HERE
        // ************************************************
        const GEMINI_API_KEY = "......."; // Confirmed Key
        
        // Global Firebase vars
        let db;
        let auth;
        let userId = 'anonymous'; 
        let appId = 'default-app-id'; // Fallback if __app_id is not defined
        let currentLang = 'kn'; 

        // ------------------------------------------
        // --- VOICE OUTPUT (TTS) LOGIC ---
        // ------------------------------------------
        
        // Initial state from local storage, defaults to true (ON)
        let isVoiceOutputEnabled = localStorage.getItem('voiceEnabled') === 'false' ? false : true; 
        const synth = window.speechSynthesis;

        // Map language codes to supported voice codes
        const voiceLangMap = {
            'kn': 'kn-IN', // Kannada
            'hi': 'hi-IN', // Hindi
            'en': 'en-US'  // English
        };

        function getVoiceForLanguage(langCode) {
            const voiceCode = voiceLangMap[langCode] || 'en-US';
            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = () => {
                    return synth.getVoices().find(voice => voice.lang.startsWith(voiceCode)) || null;
                };
            }
            return synth.getVoices().find(voice => voice.lang.startsWith(voiceCode)) || null;
        }

        window.speakText = (text, langCode) => {
            if (!synth) return; 
            synth.cancel();

            const cleanText = text.replace(/<br>/g, ' ').replace(/\*\*(.*?)\*\*/g, '$1').replace(/<\/?[^>]+(>|$)/g, "");
            const utterance = new SpeechSynthesisUtterance(cleanText);
            
            const voice = getVoiceForLanguage(langCode);
            if (voice) {
                utterance.voice = voice;
            }
            utterance.lang = voiceLangMap[langCode] || 'en-US'; 

            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            synth.speak(utterance);
        };
        
        function updateVoiceIcon() {
            const icon = document.getElementById('voice-icon');
            const button = document.getElementById('voice-toggle-btn');
            
            if (isVoiceOutputEnabled) {
                // Green speaker icon for ON
                button.classList.remove('bg-red-700');
                button.classList.add('bg-green-500');
                icon.innerHTML = `<path d="M5.525 3.514A.75.75 0 016 4v12a.75.75 0 01-1.25.568l-3.25-3a.75.75 0 01-.25-.568V6a.75.75 0 01.25-.568l3.25-3zM10.25 6a.75.75 0 01.75.75v6.5a.75.75 0 01-1.5 0V6.75a.75.75 0 01.75-.75zM12.5 8a.75.75 0 01.75.75v2.5a.75.75 0 01-1.5 0V8.75a.75.75 0 01.75-.75zM14.75 9.75a.75.75 0 00-1.5 0v.5a.75.75 0 001.5 0v-.5z" fill-rule="evenodd" clip-rule="evenodd" />`;
            } else {
                // Red slashed speaker icon for OFF
                button.classList.remove('bg-green-500');
                button.classList.add('bg-red-700');
                icon.innerHTML = `<path d="M5.525 3.514A.75.75 0 016 4v12a.75.75 0 01-1.25.568l-3.25-3a.75.75 0 01-.25-.568V6a.75.75 0 01.25-.568l3.25-3zM17.25 10a.75.75 0 000-1.5h-5.5a.75.75 0 000 1.5h5.5z" fill-rule="evenodd" clip-rule="evenodd" />`;
            }
        }

        window.toggleVoiceOutput = () => {
            isVoiceOutputEnabled = !isVoiceOutputEnabled;
            localStorage.setItem('voiceEnabled', isVoiceOutputEnabled);
            updateVoiceIcon();
            
            if (!isVoiceOutputEnabled) {
                synth.cancel(); 
            }
        };

        window.addEventListener('load', updateVoiceIcon);

        // ------------------------------------------
        // --- VOICE INPUT (STT) LOGIC ---
        // ------------------------------------------

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isListening = false;
        
        // Map language codes to Speech Recognition language codes
        const recognitionLangMap = {
            'kn': 'kn-IN', 
            'hi': 'hi-IN', 
            'en': 'en-US'  
        };

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.interimResults = false; 
            recognition.continuous = false; 
            recognition.maxAlternatives = 1;
            
            const micBtn = document.getElementById('mic-btn');
            const chatInput = document.getElementById('chat-input');

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.remove('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
                micBtn.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white', 'animate-pulse');
                chatInput.placeholder = languageContent[currentLang].input_listening; 
                chatInput.value = '';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatInput.value = transcript;
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white', 'animate-pulse');
                micBtn.classList.add('bg-gray-300', 'hover:bg-gray-400', 'text-gray-700');
                chatInput.placeholder = languageContent[currentLang].input_placeholder; 
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                recognition.onend(); // Use onend for cleanup
                
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please check your browser permissions.');
                } else if (event.error === 'no-speech') {
                    // Alert only if the user didn't stop it manually
                    if (isListening) alert(languageContent[currentLang].no_speech_detected);
                }
            };
        } else {
            console.warn("Web Speech API not supported in this browser.");
        }

        window.startVoiceInput = () => {
            if (!recognition) {
                alert("Voice input is not supported in your browser.");
                return;
            }
            
            if (isListening) {
                recognition.stop();
                return;
            }
            
            // Set language dynamically based on the current selection
            recognition.lang = recognitionLangMap[currentLang] || 'en-US';
            recognition.start();
        };

        // ------------------------------------------
        // --- END VOICE INPUT LOGIC ---
        // ------------------------------------------
        
        // --- Firebase Initialization and Auth ---
        
        const authStatusDiv = document.getElementById('auth-status');
        
        let firebaseConfig = { 
            apiKey: "AIzaSyA-HhuhOwm4DMMDo8ZPY6uxeQDY5Z4EXdg", 
            authDomain: "aarogyaai-5a7de.firebaseapp.com",
            projectId: "aarogyaai-5a7de",
            storageBucket: "aarogyaai-5a7de.firebasestorage.app",
            messagingSenderId: "508797358331",
            appId: "1:508797358331:web:cffc2c62f434b05d6f605e",
            measurementId: "G-9CQM0WJ4PN", 
        }; 
        
        let isConfigAvailable = false;
        
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config); 
                isConfigAvailable = true;
                appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
            } else {
                if (firebaseConfig.apiKey) {
                    isConfigAvailable = true;
                    appId = firebaseConfig.projectId;
                }
            }
        } catch (e) {
            console.error("Error parsing __firebase_config:", e);
        }

        if (isConfigAvailable && firebaseConfig.apiKey) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const updateAuthStatus = (uid, method) => {
                userId = uid;
                authStatusDiv.innerHTML = `Authenticated as: <span class="font-semibold text-emerald-800 break-all">${userId}</span> (${method}).`;
                loadReminders(); 
            };

            if (initialAuthToken) {
                authStatusDiv.textContent = "Authenticating with custom token...";
                signInWithCustomToken(auth, initialAuthToken)
                    .then((userCredential) => {
                        updateAuthStatus(userCredential.user.uid, 'Custom Token');
                    })
                    .catch(() => {
                        signInAnonymously(auth).then(userCredential => {
                            updateAuthStatus(userCredential.user.uid, 'Anonymous');
                        }).catch(anonError => {
                            authStatusDiv.innerHTML = `<span class="text-red-500">Authentication Failed: Check API Key/Rules.</span>`;
                            document.getElementById('loading-reminders').innerHTML = `<p class="text-red-500">Database Error: Failed to authenticate user. Reminders disabled.</p>`;
                        });
                    });
            } else {
                authStatusDiv.textContent = "Signing in anonymously...";
                signInAnonymously(auth).then(userCredential => {
                    updateAuthStatus(userCredential.user.uid, 'Anonymous');
                }).catch(anonError => {
                    authStatusDiv.innerHTML = `<span class="text-red-500">Authentication Failed: Check API Key/Rules.</span>`;
                    document.getElementById('loading-reminders').innerHTML = `<p class="text-red-500">Database Error: Failed to authenticate user. Reminders disabled.</p>`;
                });
            }
        } else {
            document.getElementById('auth-status').innerHTML = `<span class="text-red-500">Database Error: CRITICAL CONFIGURATION MISSING.</span>`;
            document.getElementById('loading-reminders').innerHTML = `<p class="text-red-500">Database Error: Cannot connect to Firebase.</p>`;
        }


        // Localization content map (UPDATED with new keys)
        const languageContent = {
            'kn': {
                app_title: "AarogyaAI - ‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ‡≥Ä‡≤£ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø",
                header_tag: "AI ‡≤ö‡≤æ‡≤≤‡≤ø‡≤§ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤∏‡≤π‡≤æ‡≤Ø, ‡≤π‡≤≥‡≥ç‡≤≥‡≤ø‡≤ó‡≤≥‡≤ø‡≤ó‡≤æ‡≤ó‡≤ø",
                tab_chat: "ü§ñ AI ‡≤∏‡≤≤‡≤π‡≥Ü",
                tab_map: "üìç ‡≤∏‡≤Ç‡≤™‡≤®‡≥ç‡≤Æ‡≥Ç‡≤≤",
                tab_reminder: "‚è∞ ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü",
                disclaimer_text: "‚ö†Ô∏è **‡≤π‡≤ï‡≥ç‡≤ï‡≥Å‡≤§‡≥ç‡≤Ø‡≤æ‡≤ó (Disclaimer):** ‡≤á‡≤¶‡≥Å AI ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤Æ‡≤æ‡≤§‡≥ç‡≤∞. ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤ï‡≥Ä‡≤Ø ‡≤∞‡≥ã‡≤ó‡≤®‡≤ø‡≤∞‡≥ç‡≤£‡≤Ø‡≤ï‡≥ç‡≤ï‡≤æ‡≤ó‡≤ø ‡≤á‡≤¶‡≤®‡≥ç‡≤®‡≥Å ‡≤¨‡≤≥‡≤∏‡≤¨‡≥á‡≤°‡≤ø. ‡≤§‡≤ï‡≥ç‡≤∑‡≤£ ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≠‡≥á‡≤ü‡≤ø ‡≤Æ‡≤æ‡≤°‡≤ø„ÄÇ",
                input_placeholder: "‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∞‡≥ã‡≤ó‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø...",
                input_listening: "üîä ‡≤ï‡≥á‡≤≥‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü... ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≤≤‡≥Å ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø...", // NEW
                no_speech_detected: "‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤ß‡≥ç‡≤µ‡≤®‡≤ø ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∏‡≥ç‡≤™‡≤∑‡≥ç‡≤ü‡≤µ‡≤æ‡≤ó‡≤ø ‡≤Æ‡≤æ‡≤§‡≤®‡≤æ‡≤°‡≤ø„ÄÇ", // NEW
                send_btn: "‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≥Å",
                send_loading: "... ‡≤Ø‡≥ã‡≤ö‡≤ø‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü",
                ai_error: "API ‡≤ï‡≤∞‡≥Ü‡≤Ø‡≤≤‡≥ç‡≤≤‡≤ø ‡≤¶‡≥ã‡≤∑ ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤¶‡≥Ü. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤ï‡≥Ä‡≤≤‡≤ø‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤∞‡≤ø‡≤∂‡≥Ä‡≤≤‡≤ø‡≤∏‡≤ø (API Key) ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤™‡≥Å‡≤®‡≤É ‡≤™‡≥ç‡≤∞‡≤Ø‡≤§‡≥ç‡≤®‡≤ø‡≤∏‡≤ø„ÄÇ",
                ai_fallback: "‡≤ï‡≥ç‡≤∑‡≤Æ‡≤ø‡≤∏‡≤ø, ‡≤à ‡≤∏‡≤Æ‡≤∏‡≥ç‡≤Ø‡≥Ü‡≤Ø ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤®‡≤æ‡≤®‡≥Å ‡≤®‡≤ø‡≤Æ‡≤ó‡≥Ü ‡≤∏‡≤π‡≤æ‡≤Ø ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤∏‡≤æ‡≤ß‡≥ç‡≤Ø‡≤µ‡≤æ‡≤ó‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≥á‡≤∞‡≤µ‡≤æ‡≤ó‡≤ø ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï‡≤ø‡≤∏‡≤ø„ÄÇ",
                ai_welcome: "‡≤®‡≤æ‡≤®‡≥Å AarogyaAI. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∞‡≥ã‡≤ó‡≤≤‡≤ï‡≥ç‡≤∑‡≤£‡≤ó‡≤≥ ‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü ‡≤∏‡≤Ç‡≤ï‡≥ç‡≤∑‡≤ø‡≤™‡≥ç‡≤§‡≤µ‡≤æ‡≤ó‡≤ø ‡≤ï‡≤®‡≥ç‡≤®‡≤°‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤§‡≤ø‡≤≥‡≤ø‡≤∏‡≤ø„ÄÇ",
                map_title: "üìç ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ü‡≤∞‡≥ã‡≤ó‡≥ç‡≤Ø ‡≤ï‡≥á‡≤Ç‡≤¶‡≥ç‡≤∞ ‡≤∂‡≥ã‡≤ß‡≤ï",
                map_desc: "‡≤à ‡≤µ‡≥à‡≤∂‡≤ø‡≤∑‡≥ç‡≤ü‡≥ç‡≤Ø‡≤µ‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤∏‡≥ç‡≤•‡≤≥‡≤¶ ‡≤Ü‡≤ß‡≤æ‡≤∞‡≤¶ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤Ü‡≤∏‡≥ç‡≤™‡≤§‡≥ç‡≤∞‡≥Ü‡≤ó‡≤≥‡≥Å, ‡≤ï‡≥ç‡≤≤‡≤ø‡≤®‡≤ø‡≤ï‡≥ç‚Äå‡≤ó‡≤≥‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤î‡≤∑‡≤ß‡≤æ‡≤≤‡≤Ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤π‡≤ø‡≤°‡≤ø‡≤Ø‡≤≤‡≥Å Google Maps ‡≤Ö‡≤®‡≥ç‡≤®‡≥Å ‡≤¨‡≤≥‡≤∏‡≥Å‡≤§‡≥ç‡≤§‡≤¶‡≥Ü„ÄÇ",
                map_btn: "GPS ‡≤∏‡≥ç‡≤•‡≤≥‡≤¶ ‡≤Ü‡≤ß‡≤æ‡≤∞‡≤¶ ‡≤Æ‡≥á‡≤≤‡≥Ü ‡≤π‡≥Å‡≤°‡≥Å‡≤ï‡≤ø",
                reminder_title: "‚è∞ ‡≤î‡≤∑‡≤ß ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü",
                reminder_desc: "‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø. ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≥ç‡≤™‡≤°‡≥Å‡≤§‡≥ç‡≤§‡≤µ‡≥Ü„ÄÇ",
                med_name_label: "‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å",
                med_time_label: "‡≤∏‡≤Æ‡≤Ø (Time)",
                set_reminder_btn: "‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü ‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤ø",
                reminder_empty_alert: "‡≤î‡≤∑‡≤ß‡≤¶ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤Æ‡≤Ø ‡≤é‡≤∞‡≤°‡≤®‡≥ç‡≤®‡≥Ç ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø„ÄÇ",
                reminder_empty_list: "‡≤á‡≤≤‡≥ç‡≤≤‡≤ø ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤≤‡≥ç‡≤≤„ÄÇ",
                reminder_delete_btn: "‡≤Ö‡≤≥‡≤ø‡≤∏‡≤ø",
                reminder_added_on: (date) => `<span class="text-xs text-gray-500 block">(${date} ‡≤∞‡≤Ç‡≤¶‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü)</span>`,
                map_loc_error: "GPS ‡≤∏‡≥ç‡≤•‡≤≥ ‡≤≤‡≤≠‡≥ç‡≤Ø‡≤µ‡≤ø‡≤≤‡≥ç‡≤≤: ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∏‡≥ç‡≤•‡≤≥ ‡≤Ö‡≤®‡≥Å‡≤Æ‡≤§‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø‡≤ó‡≥ä‡≤≥‡≤ø‡≤∏‡≤ø„ÄÇ"
            },
            'en': {
                app_title: "AarogyaAI - Rural Health Assistant",
                header_tag: "AI-Powered Health Assistant for Rural Areas",
                tab_chat: "ü§ñ AI Advice",
                tab_map: "üìç Resources",
                tab_reminder: "‚è∞ Reminder",
                disclaimer_text: "‚ö†Ô∏è **Disclaimer:** This is AI advice only. Do not use for medical diagnosis. Consult a doctor immediately„ÄÇ",
                input_placeholder: "Enter your symptoms...",
                input_listening: "üîä Listening... start speaking...", // NEW
                no_speech_detected: "No speech detected. Please speak clearly.", // NEW
                send_btn: "Send",
                send_loading: "... Thinking",
                ai_error: "API call error. Please check your key (API Key) and try again„ÄÇ", 
                ai_fallback: "Sorry, I couldn't assist with this issue. Please contact a doctor directly„ÄÇ",
                ai_welcome: "I am AarogyaAI. Please describe your symptoms briefly in English„ÄÇ",
                map_title: "üìç Nearest Health Center Finder",
                map_desc: "This feature uses Google Maps to find nearby hospitals, clinics, and pharmacies based on your location„ÄÇ",
                map_btn: "Search based on GPS Location",
                reminder_title: "‚è∞ Medicine Reminder",
                reminder_desc: "Enter the medicine name and time. Your reminders will be saved permanently„ÄÇ",
                med_name_label: "Medicine Name",
                med_time_label: "Time",
                set_reminder_btn: "Set Reminder",
                reminder_empty_alert: "Please enter both medicine name and time„ÄÇ",
                reminder_empty_list: "No reminders have been set here„ÄÇ",
                reminder_delete_btn: "Delete",
                reminder_added_on: (date) => `<span class="text-xs text-gray-500 block"> (Added on ${date})</span>`,
                map_loc_error: "GPS location unavailable: Please enable location permissions„ÄÇ"
            },
            'hi': {
                app_title: "AarogyaAI - ‡§ó‡•ç‡§∞‡§æ‡§Æ‡•Ä‡§£ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ",
                header_tag: "AI-‡§∏‡§Ç‡§ö‡§æ‡§≤‡§ø‡§§ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ, ‡§ó‡§æ‡§Ç‡§µ‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è",
                tab_chat: "ü§ñ AI ‡§∏‡§≤‡§æ‡§π",
                tab_map: "üìç ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§®",
                tab_reminder: "‚è∞ ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï",
                disclaimer_text: "‚ö†Ô∏è **‡§Ö‡§∏‡•ç‡§µ‡•Ä‡§ï‡§∞‡§£ (Disclaimer):** ‡§Ø‡§π ‡§ï‡•á‡§µ‡§≤ AI ‡§∏‡§≤‡§æ‡§π ‡§π‡•à‡•§ ‡§ö‡§ø‡§ï‡§ø‡§§‡•ç‡§∏‡§æ ‡§®‡§ø‡§¶‡§æ‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§á‡§∏‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§® ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§§‡•Å‡§∞‡§Ç‡§§ ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§≤‡§æ‡§π ‡§≤‡•á‡§Ç„ÄÇ",
                input_placeholder: "‡§Ö‡§™‡§®‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§µ‡§ø‡§µ‡§∞‡§£ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç...",
                input_listening: "üîä ‡§∏‡•Å‡§® ‡§∞‡§π‡§æ ‡§π‡•à... ‡§¨‡•ã‡§≤‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç...", // NEW
                no_speech_detected: "‡§ï‡•ã‡§à ‡§Ü‡§µ‡§æ‡§ú‡§º ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§¨‡•ã‡§≤‡•á‡§Ç‡•§", // NEW
                send_btn: "‡§≠‡•á‡§ú‡•á‡§Ç",
                send_loading: "... ‡§∏‡•ã‡§ö ‡§∞‡§π‡§æ ‡§π‡•à",
                ai_error: "API ‡§ï‡•â‡§≤ ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•Ä ‡§ï‡•Å‡§Ç‡§ú‡•Ä (API Key) ‡§ú‡§æ‡§Ç‡§ö‡•á‡§Ç ‡§î‡§∞ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç„ÄÇ", 
                ai_fallback: "‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§á‡§∏ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•Ä‡§ß‡•á ‡§°‡•â‡§ï‡•ç‡§ü‡§∞ ‡§∏‡•á ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§ï‡§∞‡•á‡§Ç„ÄÇ",
                ai_welcome: "‡§Æ‡•à‡§Ç ‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø‡§è‡§Ü‡§à ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Ö‡§™‡§®‡•á ‡§≤‡§ï‡•ç‡§∑‡§£‡•ã‡§Ç ‡§ï‡§æ ‡§∏‡§Ç‡§ï‡•ç‡§∑‡•á‡§™ ‡§Æ‡•á‡§Ç ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§µ‡§∞‡•ç‡§£‡§® ‡§ï‡§∞‡•á‡§Ç„ÄÇ",
                map_title: "üìç ‡§®‡§ø‡§ï‡§ü‡§§‡§Æ ‡§∏‡•ç‡§µ‡§æ‡§∏‡•ç‡§•‡•ç‡§Ø ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ ‡§ñ‡•ã‡§ú‡§ï",
                map_desc: "‡§Ø‡§π ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§Ü‡§™‡§ï‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§®‡§ø‡§ï‡§ü‡§§‡§Æ ‡§Ö‡§∏‡•ç‡§™‡§§‡§æ‡§≤‡•ã‡§Ç, ‡§ï‡•ç‡§≤‡•Ä‡§®‡§ø‡§ï‡•ã‡§Ç ‡§î‡§∞ ‡§´‡§æ‡§∞‡•ç‡§Æ‡•á‡§∏‡§ø‡§Ø‡•ã‡§Ç ‡§ï‡•ã ‡§ñ‡•ã‡§ú‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è Google Maps ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§§‡•Ä ‡§π‡•à„ÄÇ",
                map_btn: "GPS ‡§∏‡•ç‡§•‡§æ‡§® ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§ñ‡•ã‡§ú‡•á‡§Ç",
                reminder_title: "‚è∞ ‡§¶‡§µ‡§æ ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï",
                reminder_desc: "‡§¶‡§µ‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§∏‡§Æ‡§Ø ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç‡•§ ‡§Ü‡§™‡§ï‡•á ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï ‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§π‡•á‡§ú‡•á ‡§ú‡§æ‡§è‡§Ç‡§ó‡•á„ÄÇ",
                med_name_label: "‡§¶‡§µ‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ",
                med_time_label: "‡§∏‡§Æ‡§Ø (Time)",
                set_reminder_btn: "‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç",
                reminder_empty_alert: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§¶‡§µ‡§æ ‡§ï‡§æ ‡§®‡§æ‡§Æ ‡§î‡§∞ ‡§∏‡§Æ‡§Ø ‡§¶‡•ã‡§®‡•ã‡§Ç ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç„ÄÇ",
                reminder_empty_list: "‡§Ø‡§π‡§æ‡§Ç ‡§ï‡•ã‡§à ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï ‡§∏‡•á‡§ü ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à„ÄÇ",
                reminder_delete_btn: "‡§Æ‡§ø‡§ü‡§æ‡§è‡§Å",
                reminder_added_on: (date) => `<span class="text-xs text-gray-500 block"> (${date} ‡§ï‡•ã ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ)</span>`,
                map_loc_error: "GPS ‡§∏‡•ç‡§•‡§æ‡§® ‡§Ö‡§®‡•Å‡§™‡§≤‡§¨‡•ç‡§ß ‡§π‡•à: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§∏‡•ç‡§•‡§æ‡§® ‡§Ö‡§®‡•Å‡§Æ‡§§‡§ø‡§Ø‡§æ‡§Å ‡§∏‡§ï‡•ç‡§∑‡§Æ ‡§ï‡§∞‡•á‡§Ç‡•§"
            }
        };

        // --- UI and Language Functions ---

        function updateUI(lang) {
            const content = languageContent[lang];
            
            document.getElementById('app-title').textContent = content.app_title;
            document.getElementById('header-tagline').textContent = content.header_tag;
            document.getElementById('tab-chat').textContent = content.tab_chat;
            document.getElementById('tab-map').textContent = content.tab_map;
            document.getElementById('tab-reminder').textContent = content.tab_reminder;
            document.getElementById('disclaimer-box').innerHTML = content.disclaimer_text;
            // Only update placeholder if not currently listening
            if (!isListening) document.getElementById('chat-input').placeholder = content.input_placeholder; 
            document.getElementById('send-btn').textContent = content.send_btn;
            document.getElementById('welcome-message').textContent = content.ai_welcome;
            document.getElementById('map-title').textContent = content.map_title;
            document.getElementById('map-desc').textContent = content.map_desc;
            document.getElementById('find-hospitals-btn').textContent = content.map_btn;
            document.getElementById('reminder-title').textContent = content.reminder_title;
            document.getElementById('reminder-desc').textContent = content.reminder_desc;
            document.getElementById('med-name-label').textContent = content.med_name_label;
            document.getElementById('med-time-label').textContent = content.med_time_label;
            document.getElementById('set-reminder-btn').textContent = content.set_reminder_btn;
            
            if (db) loadReminders();
        }

        window.changeLanguage = (langCode) => {
            currentLang = langCode;
            updateUI(langCode);
        }
        
        window.showSection = (sectionId) => {
            document.querySelectorAll('section').forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(`section-${sectionId}`).classList.remove('hidden');

            document.querySelectorAll('[id^="tab-"]').forEach(tab => {
                tab.classList.remove('text-emerald-700', 'border-emerald-700');
                tab.classList.add('text-gray-500', 'border-transparent');
            });
            document.getElementById(`tab-${sectionId}`).classList.remove('text-gray-500', 'border-transparent');
            document.getElementById(`tab-${sectionId}`).classList.add('text-emerald-700', 'border-emerald-700');
        }
        
        // --- Feature 1: AI Chat Logic ---
        function appendMessage(sender, text) {
            const chatBox = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (sender === 'user') {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = text;
            } else {
                messageDiv.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                messageDiv.classList.add('ai-message');
            }
            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight; 
        }

        window.sendQuery = async () => {
            const inputElement = document.getElementById('chat-input');
            const userQuery = inputElement.value.trim();
            const content = languageContent[currentLang];
            
            if (!userQuery) {
                return; 
            }

            if (!GEMINI_API_KEY || GEMINI_API_KEY.trim() === "") {
                console.error("CRITICAL: GEMINI_API_KEY is missing or empty.");
                appendMessage('ai', 'Error: Gemini API Key is missing. Please paste your key into the code to enable chat.');
                return;
            }
            
            appendMessage('user', userQuery);
            inputElement.value = '';

            const sendButton = document.getElementById('send-btn');
            const originalButtonText = sendButton.textContent;
            sendButton.disabled = true;
            sendButton.textContent = content.send_loading; 

            try {
                let langName;
                if (currentLang === 'kn') {
                    langName = 'Kannada';
                } else if (currentLang === 'hi') {
                    langName = 'Hindi';
                } else {
                    langName = 'English';
                }

                const systemPrompt = `You are a non-diagnostic, friendly AI health assistant providing preliminary, immediate advice. The user reports symptoms. You MUST respond in ${langName} with: 1. **Safe and immediate first aid steps or home remedies (non-prescription advice only).** 2. Common or possible causes of the symptoms. 3. A strong, bolded disclaimer to consult a doctor immediately. Use clear bullet points and simple language.`;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                
                let response;
                let result;
                for (let i = 0; i < 3; i++) { 
                    try {
                        const payload = {
                            contents: [{ parts: [{ text: userQuery }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            tools: [{ "google_search": {} }], 
                        };

                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (response.ok) {
                            result = await response.json();
                            break; 
                        } else if (response.status === 429) {
                            await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        } else {
                            throw new Error(`API returned status ${response.status}`);
                        }
                    } catch (e) {
                        if (i === 2) throw e; 
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    }
                }

                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text || content.ai_fallback;
                
                appendMessage('ai', aiResponseText);
                
                // Voice Output is conditional on the toggle state and matches currentLang
                if (isVoiceOutputEnabled) {
                    window.speakText(aiResponseText, currentLang);
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                let errorMessage = content.ai_error;
                if (error.message.includes('400')) {
                     errorMessage = languageContent[currentLang].ai_error;
                }
                appendMessage('ai', errorMessage);
            } finally {
                sendButton.disabled = false;
                sendButton.textContent = originalButtonText;
            }
        }

        // --- Feature 2: Maps Logic ---
        document.getElementById('find-hospitals-btn').addEventListener('click', () => {
            const content = languageContent[currentLang];
            const mapResultsDiv = document.getElementById('map-results');
            mapResultsDiv.classList.remove('hidden');

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const mapsUrl = `https://www.google.com/maps/search/hospital+clinic+pharmacy/@${lat},${lng},14z`;
                    window.open(mapsUrl, '_blank');
                    
                    let mapsMessage;
                    if (currentLang === 'kn') {
                        mapsMessage = `<p class="font-semibold text-gray-700">GPS ‡≤∏‡≥ç‡≤•‡≤≥: ${lat.toFixed(4)}, ${lng.toFixed(4)}</p><p class="text-xs text-emerald-600 mt-1">‡≤π‡≤§‡≥ç‡≤§‡≤ø‡≤∞‡≤¶ ‡≤∏‡≤Ç‡≤™‡≤®‡≥ç‡≤Æ‡≥Ç‡≤≤‡≤ó‡≤≥‡≤ø‡≤ó‡≤æ‡≤ó‡≤ø Google Maps ‡≤Ö‡≤®‡≥ç‡≤®‡≥Å ‡≤π‡≥ä‡≤∏ ‡≤ü‡≥ç‡≤Ø‡≤æ‡≤¨‡≥ç‚Äå‡≤®‡≤≤‡≥ç‡≤≤‡≤ø ‡≤§‡≥Ü‡≤∞‡≥Ü‡≤Ø‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü!</p>`;
                    } else if (currentLang === 'hi') {
                        mapsMessage = `<p class="font-semibold text-gray-700">GPS ‡§∏‡•ç‡§•‡§æ‡§®: ${lat.toFixed(4)}, ${lng.toFixed(4)}</p><p class="text-xs text-emerald-600 mt-1">‡§®‡§ø‡§ï‡§ü‡§§‡§Æ ‡§∏‡§Ç‡§∏‡§æ‡§ß‡§®‡•ã‡§Ç ‡§ï‡•á ‡§≤‡§ø‡§è Google Maps ‡§ï‡•ã ‡§è‡§ï ‡§®‡§è ‡§ü‡•à‡§¨ ‡§Æ‡•á‡§Ç ‡§ñ‡•ã‡§≤‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à!</p>`;
                    } else {
                        mapsMessage = `<p class="font-semibold text-gray-700">GPS Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}</p><p class="text-xs text-emerald-600 mt-1">Google Maps opened in a new tab for nearest resources!</p>`;
                    }
                    
                    mapResultsDiv.innerHTML = mapsMessage;

                }, (error) => {
                    console.error("Geolocation Error:", error.message);
                    mapResultsDiv.innerHTML = `<p class="text-red-500 font-semibold">${content.map_loc_error}</p>`;
                }, { enableHighAccuracy: true });
            } else {
                console.error("Geolocation Error: Browser does not support geolocation.");
                mapResultsDiv.innerHTML = `<p class="text-red-500 font-semibold">${content.map_loc_error}</p>`;
            }
        });

        // --- Feature 3: Reminder Logic (Firestore) ---

        function renderReminderItem(reminder, docId) {
            const content = languageContent[currentLang];
            
            let addedText = '';
            if (reminder.createdAt && reminder.createdAt.toDate) {
                const date = reminder.createdAt.toDate().toLocaleDateString(currentLang, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                addedText = content.reminder_added_on(date);
            }

            let reminderText;
            if (currentLang === 'kn') {
                reminderText = `**${reminder.name}** ‡≤ó‡≤æ‡≤ó‡≤ø ‡≤ú‡≥ç‡≤û‡≤æ‡≤™‡≤®‡≥Ü‡≤Ø‡≤®‡≥ç‡≤®‡≥Å **${reminder.time}** ‡≤ó‡≥Ü ‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü„ÄÇ`;
            } else if (currentLang === 'hi') {
                reminderText = `**${reminder.name}** ‡§ï‡•á ‡§≤‡§ø‡§è ‡§Ö‡§®‡•Å‡§∏‡•ç‡§Æ‡§æ‡§∞‡§ï **${reminder.time}** ‡§™‡§∞ ‡§∏‡•á‡§ü ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ ‡§π‡•à‡•§`;
            } else {
                reminderText = `Reminder for **${reminder.name}** set for **${reminder.time}**„ÄÇ`;
            }
            
            return `
                <div id="reminder-${docId}" class="p-3 bg-emerald-50 rounded-lg border border-emerald-200 text-sm text-emerald-800 flex flex-col justify-between items-start">
                    <div class="flex justify-between items-center w-full">
                        <p class="font-semibold">${reminderText.replace(/\*\*(.*?)\*\*/g, '<strong class="text-emerald-900">$1</strong>')}</p>
                        <button onclick="deleteReminder('${docId}')" class="text-red-600 hover:text-red-800 p-1 transition duration-150 flex-shrink-0" title="${content.reminder_delete_btn}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    ${addedText}
                </div>
            `;
        }

        window.loadReminders = () => {
            if (!db || userId === 'anonymous') {
                document.getElementById('loading-reminders').textContent = "Waiting for user authentication...";
                return;
            }

            const remindersCollectionPath = `artifacts/${appId}/users/${userId}/reminders`;
            const remindersQuery = query(collection(db, remindersCollectionPath));
            const listDiv = document.getElementById('reminder-list');
            
            listDiv.innerHTML = `<div class="p-3 bg-blue-50 rounded-lg border border-blue-200 text-sm text-blue-800" id="loading-reminders">Loading reminders...</div>`;

            onSnapshot(remindersQuery, (snapshot) => {
                listDiv.innerHTML = ''; 
                
                if (snapshot.empty) {
                    listDiv.innerHTML = `<div class="p-3 bg-gray-50 rounded-lg border border-gray-200 text-sm text-gray-700">${languageContent[currentLang].reminder_empty_list}</div>`;
                    return;
                }

                const reminders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                reminders.sort((a, b) => a.time.localeCompare(b.time)); 

                reminders.forEach(reminder => {
                    const html = renderReminderItem(reminder, reminder.id);
                    listDiv.innerHTML += html;
                });
            }, (error) => {
                let errorMessage = error.message.includes('permission denied') 
                    ? `Database Error (Permission Denied): Check your Firebase Security Rules„ÄÇ`
                    : `Error loading reminders: ${error.message}`;
                    
                listDiv.innerHTML = `<div class="p-3 bg-red-100 rounded-lg border border-red-300 text-sm text-red-800">${errorMessage}</div>`;
            });
        }

        window.setReminder = async () => {
            if (!db || userId === 'anonymous') {
                return;
            }

            const name = document.getElementById('med-name').value.trim();
            const time = document.getElementById('med-time').value.trim();
            const content = languageContent[currentLang];
            
            if (!name || !time) {
                const listDiv = document.getElementById('reminder-list');
                const errorHtml = `<div class="p-3 bg-red-100 rounded-lg border border-red-300 text-sm text-red-800 mb-2">${content.reminder_empty_alert}</div>`;
                listDiv.insertAdjacentHTML('afterbegin', errorHtml); 
                setTimeout(() => { 
                    const errorDiv = listDiv.querySelector('.bg-red-100');
                    if(errorDiv) errorDiv.remove();
                }, 3000); 
                return;
            }

            const reminder = {
                name: name,
                time: time,
                status: 'active',
                createdAt: serverTimestamp() 
            };

            const remindersCollection = collection(db, `artifacts/${appId}/users/${userId}/reminders`);
            const setBtn = document.getElementById('set-reminder-btn');
            const originalBtnText = setBtn.textContent;
            setBtn.disabled = true;
            setBtn.textContent = (currentLang === 'kn' ? '‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...' : currentLang === 'hi' ? '‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...' : 'Saving...');


            try {
                await addDoc(remindersCollection, reminder);
                document.getElementById('med-name').value = '';
                document.getElementById('med-time').value = '';
            } catch (error) {
                const listDiv = document.getElementById('reminder-list');
                const errorMessage = `Error saving reminder: ${error.message}`;
                const errorHtml = `<div class="p-3 bg-red-100 rounded-lg border border-red-300 text-sm text-red-800 mb-2">${errorMessage}</div>`;
                listDiv.insertAdjacentHTML('afterbegin', errorHtml);
                setTimeout(() => { 
                    const errorDiv = listDiv.querySelector('.bg-red-100');
                    if(errorDiv) errorDiv.remove();
                }, 5000); 
            } finally {
                setBtn.disabled = false;
                setBtn.textContent = originalBtnText;
            }
        }
        
        window.deleteReminder = async (docId) => {
            if (!db || userId === 'anonymous') {
                return;
            }
            
            const remindersCollectionPath = `artifacts/${appId}/users/${userId}/reminders`;
            const docRef = doc(db, remindersCollectionPath, docId);

            try {
                await deleteDoc(docRef);
            } catch (error) {
                const listDiv = document.getElementById('reminder-list');
                const errorMessage = `Error deleting reminder: ${error.message}`;
                const errorHtml = `<div class="p-3 bg-red-100 rounded-lg border border-red-300 text-sm text-red-800 mb-2">${errorMessage}</div>`;
                listDiv.insertAdjacentHTML('afterbegin', errorHtml);
                setTimeout(() => { 
                    const errorDiv = listDiv.querySelector('.bg-red-100');
                    if(errorDiv) errorDiv.remove();
                }, 5000); 
            }
        }

        // --- Initial Load ---
        window.onload = () => {
            changeLanguage(currentLang); 
        };

    </script>
</body>
</html>
